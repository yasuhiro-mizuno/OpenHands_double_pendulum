---

# 二重振り子シミュレーション仕様書

## 概要

本プログラムは、二重振り子の運動を物理的に正確な運動方程式に基づいて数値的にシミュレーションし、アニメーションとして可視化するものである。微小な初期条件の違いによる軌道の差異を比較する機能も備えており、カオス的挙動の可視化にも対応している。

---

## 使用ライブラリ

- `numpy`: 数値計算
- `matplotlib`: グラフ描画およびアニメーション
- `scipy.integrate.odeint`: 常微分方程式の数値解法

---

## 物理モデル

### 状態変数

- $\theta_1$：第1振り子の角度（鉛直方向からの偏角）  
- $\theta_2$：第2振り子の角度  
- $\omega_1 = \dot{\theta}_1$：第1振り子の角速度  
- $\omega_2 = \dot{\theta}_2$：第2振り子の角速度  
- $\Delta\theta = \theta_2 - \theta_1$：角度差  

### パラメータ

- $m_1$：第1振り子の質量  
- $m_2$：第2振り子の質量  
- $L_1$：第1振り子の長さ  
- $L_2$：第2振り子の長さ  
- $g$：重力加速度  

---

## 運動方程式

### 第1振り子の角加速度（$\ddot{\theta}_1$）

$$
\ddot{\theta}_1 = \frac{
    -m_2 L_1 \omega_1^2 \sin(\Delta\theta) \cos(\Delta\theta)
    + m_2 g \sin(\theta_2) \cos(\Delta\theta)
    + m_2 L_2 \omega_2^2 \sin(\Delta\theta)
    - (m_1 + m_2) g \sin(\theta_1)
}{
    (m_1 + m_2) L_1 - m_2 L_1 \cos^2(\Delta\theta)
}
$$

### 第2振り子の角加速度（$\ddot{\theta}_2$）

$$
\ddot{\theta}_2 = \frac{
    -m_2 L_2 \omega_2^2 \sin(\Delta\theta) \cos(\Delta\theta)
    + (m_1 + m_2) g \sin(\theta_1) \cos(\Delta\theta)
    - (m_1 + m_2) L_1 \omega_1^2 \sin(\Delta\theta)
    - (m_1 + m_2) g \sin(\theta_2)
}{
    \left(\frac{L_2}{L_1}\right) \left[(m_1 + m_2) L_1 - m_2 L_1 \cos^2(\Delta\theta)\right]
}
$$

これらの式は非線形かつ相互に結合しており、解析的に解くことは困難である。そのため、プログラムでは数値解法 `odeint` を用いて時間発展を計算する。

---

## クラス構成

### `DoublePendulum`

二重振り子の物理モデルを定義するクラス。

#### コンストラクタ

```python
DoublePendulum(L1=1.0, L2=1.0, m1=1.0, m2=1.0, g=9.81)
```

- `L1`, `L2`: 振り子の長さ [m]  
- `m1`, `m2`: 振り子の質量 [kg]  
- `g`: 重力加速度 [m/s²]  

#### 主なメソッド

- `derivatives(state, t)`：運動方程式を定義する  
- `simulate(initial_conditions, t_span, dt=0.01)`：シミュレーションを実行する  
- `get_cartesian_coords(solution)`：極座標をデカルト座標に変換する 

---

## アニメーション機能

### `create_dual_animation(...)`

2つの初期条件による振り子の軌道を並列表示し、GIFまたはMP4として保存可能である。軌跡の比較が可能。

### `create_animation(...)`

単一の振り子軌道を表示する（後方互換用）。

## 軌道プロット機能

### `plot_trajectories(...)`

二重振り子の軌道を静止画として可視化する機能である。アニメーションと同じレイアウトで以下を表示する：

- **並列表示**: 2つの初期条件による振り子を左右に配置
- **軌跡表示**: 第2振り子の先端軌跡をXY平面で表示
- **最終位置**: シミュレーション終了時の振り子の位置を表示
- **英語表記**: フォントエラー回避のため、グラフ内の文字は英語で表示

---

## メイン処理 `main()`

1. 二重振り子オブジェクトを生成する  
2. 初期条件1・2を設定する（微小差あり）  
3. シミュレーションを実行する（時間範囲: 0〜20秒、刻み: 0.01秒）    
4. アニメーションを作成・表示する（初期値を図内に記載）  
5. 軌道プロットを作成・表示する（静止画、初期値を図内に記載）  
6. GIF/MP4/静止画を保存する（オプション）  

---

## 出力

- アニメーション表示（matplotlib）  
- 軌道プロット表示（静止画）  
- GIFファイル（オプション）  
- MP4ファイル（オプション）  
- PNGファイル（軌道プロット、オプション）

---

## 保存設定

```python
SAVE_GIF = False
SAVE_VIDEO = False
SAVE_PLOTS = False
```

保存を有効にするには、`main()` 関数内の上記フラグを `True` に変更する必要がある。

---

## 注意事項

- 保存失敗時には HTML形式での代替保存を試行する。  

---